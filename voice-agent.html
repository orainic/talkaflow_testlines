<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">TalkaFlow Voice AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="icon" type="image/png" href="/talkaFlow_logo_only.png">
  <!-- Load SDK from multiple sources -->
  <script>
    window.loadSDK = async function() {
      const sources = [
        'https://cdn.skypack.dev/ultravox-client@0.4.1',
        'https://unpkg.com/ultravox-client@0.4.1?module',
        'https://esm.run/ultravox-client@0.4.1',
        'https://cdn.jsdelivr.net/npm/ultravox-client@0.4.1/+esm'
      ];

      for (const src of sources) {
        try {
          const module = await import(src);
          if (module.UltravoxSession) {
            window.UltravoxSession = module.UltravoxSession;
            console.log('✅ SDK loaded from:', src);
            return true;
          }
        } catch (e) {
          console.log('❌ Failed:', src, e.message);
        }
      }
      return false;
    };
  </script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <!-- Header with Logo -->
  <div class="bg-white shadow-sm border-b">
    <div class="max-w-4xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <img src="/talkaFlow_logo_only.png" alt="TalkaFlow" class="w-10 h-10" />
          <div>
            <h1 id="agentName" class="text-xl font-bold text-gray-900">TalkaFlow Voice AI</h1>
            <p id="agentTitle" class="text-sm text-gray-600">AI Voice Assistant</p>
          </div>
        </div>
        <div id="connectionStatus" class="flex items-center space-x-2">
          <div id="statusDot" class="w-3 h-3 rounded-full bg-gray-400"></div>
          <span id="statusText" class="text-sm font-medium text-gray-600">Disconnected</span>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-4xl mx-auto px-4 py-8">
    <!-- Main Call Interface -->
    <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
      <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-600 rounded-full mb-4">
          <i id="agentIcon" class="fas fa-microphone text-white text-2xl"></i>
        </div>
        <h2 id="agentDescription" class="text-2xl font-bold text-gray-900 mb-4">AI Voice Assistant</h2>

        <!-- Call Button -->
        <div class="space-y-4">
          <button id="callButton"
                  class="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-12 py-6 rounded-xl font-bold text-xl transition-all transform hover:scale-105 shadow-lg disabled:cursor-not-allowed disabled:transform-none">
            <i id="callIcon" class="fas fa-phone mr-3"></i>
            <span id="callText">Start Voice Call</span>
          </button>

          <p class="text-sm text-gray-600">
            Click to connect with the AI assistant
          </p>
        </div>
      </div>

      <!-- What You Can Ask -->
      <div id="suggestionsContainer" class="bg-blue-50 rounded-lg p-6 mb-6">
        <h3 class="font-semibold text-blue-900 mb-3">
          <i class="fas fa-question-circle mr-2"></i>
          What you can ask:
        </h3>
        <div id="suggestionsList" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-blue-800">
          <!-- Dynamically populated -->
        </div>
      </div>

      <!-- Conversation Area -->
      <div class="bg-gray-50 rounded-lg p-6">
        <h3 class="font-semibold text-gray-900 mb-4 flex items-center">
          <i class="fas fa-comments mr-2"></i>
          Conversation
        </h3>
        <div id="conversation" class="space-y-3 max-h-96 overflow-y-auto">
          <div class="text-center text-gray-500 py-8">
            <i class="fas fa-microphone text-4xl mb-3 opacity-30"></i>
            <p>Start a call to begin speaking with the AI assistant</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Debug Panel - Small Icon Only -->
    <div class="fixed bottom-4 right-4">
      <button id="debugToggle" class="bg-gray-200 hover:bg-gray-300 text-gray-600 w-10 h-10 rounded-full shadow-lg flex items-center justify-center transition-all" title="Technical Information">
        <i class="fas fa-info text-sm"></i>
      </button>
    </div>

    <!-- Debug Panel Modal (Hidden by default) -->
    <div id="debugModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-96 flex flex-col">
        <div class="flex items-center justify-between p-4 border-b">
          <h3 class="font-medium text-gray-900 flex items-center">
            <i class="fas fa-cog mr-2"></i>
            Technical Information
          </h3>
          <button id="debugClose" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="debugInfo" class="p-4 text-xs font-mono text-gray-600 overflow-y-auto flex-1">
          <p>Loading system...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Load agent configuration
    let agentConfig = null;
    let agentsData = null;

    // Parse URL to get agent type - check both path and query param
    function getAgentType() {
      // First check query parameter
      const urlParams = new URLSearchParams(window.location.search);
      const queryAgent = urlParams.get('agent');
      if (queryAgent) return queryAgent;

      // Then check path (e.g., /hotel, /clinic)
      const path = window.location.pathname;
      const pathMatch = path.match(/\/(hotel|clinic|aftersales|restaurant|hairstudio|hepa|dental)/);
      if (pathMatch) return pathMatch[1];

      // Default to hotel
      return 'hotel';
    }

    const agentType = getAgentType();

    // Load agents config
    fetch('/agents-config.json')
      .then(res => res.json())
      .then(data => {
        agentsData = data;
        agentConfig = data[agentType];

        if (!agentConfig) {
          console.error('Unknown agent type:', agentType);
          agentConfig = data.hotel; // Fallback to hotel
        }

        // Update page with agent info
        updateAgentInfo();

        // Enable button if SDK is already loaded
        updateCallButton();
      })
      .catch(err => {
        console.error('Failed to load agent config:', err);
      });

    function updateAgentInfo() {
      if (!agentConfig) return;

      // Update page title and meta
      document.title = `${agentConfig.name} - TalkaFlow Voice AI`;
      document.getElementById('pageTitle').textContent = `${agentConfig.name} - TalkaFlow`;
      document.getElementById('agentName').textContent = agentConfig.name;
      document.getElementById('agentTitle').textContent = agentConfig.title;
      document.getElementById('agentDescription').textContent = agentConfig.description;
      document.getElementById('agentIcon').className = `fas ${agentConfig.icon} text-white text-2xl`;

      // Update suggestions
      const suggestionsList = document.getElementById('suggestionsList');
      suggestionsList.innerHTML = '';
      agentConfig.suggestions.forEach(suggestion => {
        const div = document.createElement('div');
        div.className = 'flex items-start';
        div.innerHTML = `
          <i class="fas fa-comment-dots text-blue-600 mr-2 mt-1 flex-shrink-0"></i>
          <span>"${suggestion}"</span>
        `;
        suggestionsList.appendChild(div);
      });

      log(`Agent loaded: ${agentConfig.name} (${agentConfig.id})`);
    }

    // UI Elements
    const callButton = document.getElementById('callButton');
    const callIcon = document.getElementById('callIcon');
    const callText = document.getElementById('callText');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const conversation = document.getElementById('conversation');
    const debugInfo = document.getElementById('debugInfo');
    const debugToggle = document.getElementById('debugToggle');
    const debugModal = document.getElementById('debugModal');
    const debugClose = document.getElementById('debugClose');

    // State
    let session = null;
    let isConnected = false;
    let audioStream = null;
    let transcriptMap = new Map(); // Track messages by speaker-specific IDs

    // Logging
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const icon = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';

      const div = document.createElement('div');
      div.className = `mb-1 ${type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-600'}`;
      div.innerHTML = `<span class="text-gray-400">[${timestamp}]</span> ${icon} ${message}`;

      debugInfo.appendChild(div);
      debugInfo.scrollTop = debugInfo.scrollHeight;
      console.log(`[${timestamp}] ${message}`);
    }

    // Update status
    function updateStatus(status) {
      const statuses = {
        'disconnected': { color: 'bg-gray-400', text: 'Disconnected' },
        'connecting': { color: 'bg-yellow-500 animate-pulse', text: 'Connecting...' },
        'connected': { color: 'bg-green-500', text: 'Connected' },
        'listening': { color: 'bg-blue-500 animate-pulse', text: 'Listening' },
        'speaking': { color: 'bg-red-500', text: 'AI Speaking' }
      };

      const s = statuses[status] || statuses.disconnected;
      statusDot.className = `w-3 h-3 rounded-full ${s.color}`;
      statusText.textContent = s.text;

      isConnected = status !== 'disconnected';
      updateCallButton();
    }

    // Update call button
    function updateCallButton() {
      if (isConnected) {
        callButton.className = 'bg-red-600 hover:bg-red-700 text-white px-12 py-6 rounded-xl font-bold text-xl transition-all transform hover:scale-105 shadow-lg';
        callIcon.className = 'fas fa-phone-slash mr-3';
        callText.textContent = 'End Call';
        callButton.disabled = false;
      } else {
        callButton.className = 'bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-12 py-6 rounded-xl font-bold text-xl transition-all transform hover:scale-105 shadow-lg disabled:cursor-not-allowed disabled:transform-none';
        callIcon.className = 'fas fa-phone mr-3';
        callText.textContent = 'Start Voice Call';
        callButton.disabled = typeof UltravoxSession === 'undefined' || !agentConfig;
      }
    }

    // Add or update message to conversation
    function addOrUpdateMessage(speaker, text, isFinal = false) {
      if (conversation.children.length === 1 && conversation.children[0].querySelector('.fa-microphone')) {
        conversation.innerHTML = '';
      }

      // Only show final transcripts to avoid duplicates
      if (!isFinal) {
        return; // Skip interim/non-final transcripts
      }

      // Create new message for final transcript
      const messageDiv = document.createElement('div');
      messageDiv.className = `flex items-start space-x-3 p-4 rounded-lg ${
        speaker === 'user'
          ? 'bg-blue-100 border-l-4 border-blue-500 ml-4'
          : 'bg-white border-l-4 border-gray-300 mr-4 shadow-sm'
      }`;

      messageDiv.innerHTML = `
        <div class="flex-shrink-0">
          ${speaker === 'user'
            ? `<div class="w-8 h-8 rounded-full flex items-center justify-center bg-blue-600 text-white">
                <i class="fas fa-user text-sm"></i>
              </div>`
            : `<img src="talkaFlow_logo_only.png" alt="TalkaFlow" class="w-8 h-8 rounded-full object-cover" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';" />
               <div class="w-8 h-8 rounded-full bg-gray-600 text-white items-center justify-center" style="display:none;">
                <i class="fas fa-robot text-sm"></i>
              </div>`
          }
        </div>
        <div class="flex-1">
          <div class="font-medium text-sm ${speaker === 'user' ? 'text-blue-900' : 'text-gray-900'} mb-1">
            ${speaker === 'user' ? 'You' : (agentConfig ? agentConfig.name : 'AI Assistant')}
          </div>
          <p class="text-gray-700">${text}</p>
        </div>
      `;

      conversation.appendChild(messageDiv);
      conversation.scrollTop = conversation.scrollHeight;
    }

    // Legacy function for static messages
    function addMessage(speaker, text) {
      addOrUpdateMessage(speaker, text, true);
    }

    // Create call
    async function createCall() {
      try {
        log(`Making API request via proxy: /api/ultravox`);

        const response = await fetch('/api/ultravox', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ agentId: agentConfig.id })
        });

        log(`Response status: ${response.status}`);

        if (!response.ok) {
          const errorData = await response.json();
          log(`API error response: ${JSON.stringify(errorData)}`, 'error');
          throw new Error(`API Error ${response.status}: ${errorData.error || 'Unknown error'}`);
        }

        const data = await response.json();
        log(`Call created successfully: ${data.callId}`, 'success');
        return data;
      } catch (error) {
        log(`Fetch error: ${error.message}`, 'error');
        if (error.message.includes('Failed to fetch')) {
          throw new Error('Network error: Unable to connect to API proxy.');
        }
        throw error;
      }
    }

    // Start call
    async function startCall() {
      try {
        log('Starting voice call...');
        updateStatus('connecting');

        if (typeof UltravoxSession === 'undefined') {
          throw new Error('Voice SDK not loaded. Please refresh the page.');
        }

        if (!agentConfig) {
          throw new Error('Agent configuration not loaded. Please refresh the page.');
        }

        // Create call
        const callData = await createCall();
        log(`Call created: ${callData.callId}`, 'success');

        // Initialize session
        session = new UltravoxSession();

        // Setup listeners
        session.addEventListener('status', () => {
          updateStatus(session.status);
          log(`Status: ${session.status}`);
        });

        session.addEventListener('transcripts', () => {
          const transcripts = session.transcripts;
          if (transcripts && transcripts.length > 0) {
            const latest = transcripts[transcripts.length - 1];
            log(`Transcript: [${latest.speaker}] "${latest.text}" (final: ${latest.isFinal})`);

            // Determine speaker
            const speaker = latest.speaker === 'user' ? 'user' : 'agent';

            // Update or create message
            addOrUpdateMessage(speaker, latest.text, latest.isFinal);
          }
        });

        // Join call
        await session.joinCall(callData.joinUrl);
        log('Voice call connected!', 'success');

      } catch (error) {
        log(`Call failed: ${error.message}`, 'error');
        updateStatus('disconnected');
        alert(`Failed to start call: ${error.message}`);
      }
    }

    // End call
    async function endCall() {
      try {
        log('Ending call...');

        if (session) {
          await session.leaveCall();
          session = null;
        }

        if (audioStream) {
          audioStream.getTracks().forEach(track => track.stop());
          audioStream = null;
        }

        updateStatus('disconnected');
        log('Call ended', 'success');

        addMessage('agent', `Thank you for contacting ${agentConfig.name}. Have a wonderful day!`);

      } catch (error) {
        log(`Error ending call: ${error.message}`, 'error');
        updateStatus('disconnected');
      }
    }

    // Call button handler
    callButton.addEventListener('click', () => {
      if (isConnected) {
        endCall();
      } else {
        startCall();
      }
    });

    // Debug modal handlers
    debugToggle.addEventListener('click', () => {
      debugModal.classList.remove('hidden');
      debugModal.classList.add('flex');
    });

    debugClose.addEventListener('click', () => {
      debugModal.classList.add('hidden');
      debugModal.classList.remove('flex');
    });

    // Close modal when clicking outside
    debugModal.addEventListener('click', (e) => {
      if (e.target === debugModal) {
        debugModal.classList.add('hidden');
        debugModal.classList.remove('flex');
      }
    });

    // Auto-cleanup when page is closed or navigated away
    window.addEventListener('beforeunload', (event) => {
      if (session && isConnected) {
        log('Page closing - ending call automatically');
        // End call immediately without waiting
        if (session) {
          try {
            session.leaveCall();
          } catch (e) {
            console.error('Error leaving call:', e);
          }
        }
        if (audioStream) {
          audioStream.getTracks().forEach(track => track.stop());
        }
      }
    });

    // Also handle page visibility changes (tab switching, minimizing)
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && session && isConnected) {
        log('Page hidden - user may have closed tab/window');
        // Give a grace period, then end call if still hidden
        setTimeout(() => {
          if (document.hidden && session && isConnected) {
            log('Page still hidden after 2s - ending call to save costs');
            endCall();
          }
        }, 2000);
      }
    });

    // Handle page unload (when navigating to another page)
    window.addEventListener('pagehide', () => {
      if (session && isConnected) {
        log('Page unloading - ending call');
        if (session) {
          try {
            session.leaveCall();
          } catch (e) {
            console.error('Error leaving call:', e);
          }
        }
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      log('TalkaFlow Voice AI Interface loaded');
      updateStatus('disconnected');

      // Load SDK
      log('Loading voice processing SDK...');
      try {
        const loaded = await window.loadSDK();
        if (loaded) {
          log('Voice SDK loaded successfully!', 'success');
          updateCallButton();
        } else {
          log('Failed to load voice SDK', 'error');
          callButton.disabled = true;
          callText.textContent = 'Voice SDK Unavailable';
        }
      } catch (error) {
        log(`SDK error: ${error.message}`, 'error');
        callButton.disabled = true;
      }
    });
  </script>
</body>
</html>
