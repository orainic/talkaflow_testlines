<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">TalkaFlow Voice AI</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/tokens.css">
    <link rel="stylesheet" href="/static/base.css">
    <link rel="stylesheet" href="/static/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        (function(){
            var t = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', t);
            if (t === 'dark') document.documentElement.classList.add('dark');
        })();
    </script>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .page-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-3);
        }

        /* Top bar: logo + toggle */
        .top-bar {
            width: 420px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .top-bar .logo-container { height: 28px; }

        /* Theme toggle */
        .theme-toggle { cursor: pointer; user-select: none; }
        .theme-track {
            position: relative; width: 48px; height: 24px; border-radius: 12px;
            background: var(--palette-slate-300); transition: background-color 0.3s;
        }
        [data-theme="dark"] .theme-track { background: var(--palette-indigo-600); }
        .theme-thumb {
            width: 20px; height: 20px; border-radius: 50%; background: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3); position: absolute; top: 2px; left: 2px;
            transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
        }
        .theme-icon {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 16px; height: 16px; display: flex; align-items: center;
            justify-content: center; transition: opacity 0.2s;
        }
        .theme-icon-sun { left: 4px; color: #f59e0b; }
        .theme-icon-moon { right: 4px; color: #a5b4fc; opacity: 0; }

        /* Main frame */
        .voice-container {
            width: 420px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-lg);
        }

        /* Header */
        .voice-header {
            background: linear-gradient(135deg, var(--palette-indigo-600), var(--palette-indigo-800));
            color: #fff;
            padding: var(--spacing-4) var(--spacing-5);
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }

        .voice-header .header-icon {
            width: 40px; height: 40px; border-radius: var(--radius-full);
            background: rgba(255,255,255,0.15);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; flex-shrink: 0;
        }

        .voice-header .info h2 { font-size: 1rem; font-weight: 600; margin-bottom: 0; color: #fff; }
        .voice-header .info p { font-size: 0.75rem; opacity: 0.85; margin-top: 2px; }

        .status-dot-header {
            width: 8px; height: 8px; background: #4ade80;
            border-radius: var(--radius-full); display: inline-block; margin-right: 4px;
        }

        /* Content area */
        .voice-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-5);
            background: var(--bg-page);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-5);
        }

        /* Status text */
        .status-area {
            text-align: center;
        }
        .status-label {
            font-size: 1.125rem; font-weight: 600; color: var(--text-primary);
        }
        .status-sub {
            font-size: 0.8125rem; color: var(--text-tertiary); margin-top: 2px;
        }

        /* Call Button */
        .call-area { text-align: center; }

        .call-btn {
            width: 80px; height: 80px; border-radius: var(--radius-full);
            color: #fff; font-size: 1.5rem; box-shadow: var(--shadow-lg);
            transition: all 0.2s; display: inline-flex;
            align-items: center; justify-content: center; background: #008250;
        }
        .call-btn:hover:not(:disabled) { transform: scale(1.1); }
        .call-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .call-btn.active { background: var(--palette-red-500); }

        @keyframes pulse-btn {
            0% { box-shadow: 0 0 0 0 rgba(0, 130, 80, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(0, 130, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 130, 80, 0); }
        }
        .call-btn:not(:disabled):not(.active) { animation: pulse-btn 2s ease-in-out infinite; }
        .call-btn.active { animation: none; }

        .call-label {
            font-size: 0.875rem; color: var(--text-secondary); margin-top: var(--spacing-2);
        }

        /* Suggestions */
        .suggestions {
            background: var(--primary-light); border-radius: var(--radius-lg);
            padding: var(--spacing-3) var(--spacing-4);
            border: 1px solid rgba(99, 102, 241, 0.1); width: 100%;
        }
        .suggestions .label {
            font-size: 0.6875rem; font-weight: 600; color: var(--primary-text);
            margin-bottom: var(--spacing-1);
        }
        .suggestions .label i { margin-right: var(--spacing-1); }
        .suggestions p {
            font-size: 0.8125rem; color: var(--primary-text);
            margin: 2px 0; line-height: 1.5;
        }

        /* Transcript */
        .transcript-section {
            background: var(--bg-card); border-radius: var(--radius-lg);
            padding: var(--spacing-3) var(--spacing-4);
            border: 1px solid var(--border-light); width: 100%;
        }
        .transcript-title {
            font-size: 0.6875rem; font-weight: 600; color: var(--text-tertiary);
            text-transform: uppercase; letter-spacing: 0.05em;
            margin-bottom: var(--spacing-2);
        }
        .transcript-title i { margin-right: var(--spacing-1); }

        .transcript-area {
            max-height: 220px; overflow-y: auto;
            display: flex; flex-direction: column; gap: var(--spacing-2);
        }

        .transcript-placeholder {
            text-align: center; color: var(--text-tertiary);
            font-size: 0.8125rem; padding: var(--spacing-3) 0;
        }
        .transcript-placeholder i {
            font-size: 1.25rem; display: block;
            margin-bottom: var(--spacing-1); opacity: 0.3;
        }

        .transcript-msg {
            display: flex; align-items: flex-start; gap: var(--spacing-2);
            padding: var(--spacing-1) var(--spacing-2); border-radius: var(--radius-md);
        }
        .transcript-msg.user-msg { background: var(--primary-light); }
        .transcript-msg.agent-msg { background: var(--bg-page); border: 1px solid var(--border-light); }

        .transcript-avatar {
            width: 22px; height: 22px; border-radius: var(--radius-full);
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; margin-top: 2px;
        }
        .transcript-avatar.user-avatar { background: var(--primary-default); }
        .transcript-avatar.agent-avatar { background: var(--palette-slate-600); }
        .transcript-avatar i { color: #fff; font-size: 0.5625rem; }

        .transcript-speaker { font-size: 0.6875rem; font-weight: 600; }
        .transcript-speaker.user-name { color: var(--primary-text); }
        .transcript-speaker.agent-name { color: var(--text-primary); }
        .transcript-text { font-size: 0.8125rem; color: var(--text-primary); }

        /* Footer */
        .nav-links {
            text-align: center; padding: var(--spacing-2); font-size: 0.75rem;
            color: var(--text-tertiary); background: var(--bg-card);
            border-top: 1px solid var(--border-light);
        }
        .nav-links a { color: var(--primary-text); margin: 0 var(--spacing-2); }

        .powered-by {
            text-align: center; padding: var(--spacing-2); font-size: 0.6875rem;
            color: var(--text-tertiary); background: var(--bg-card);
        }
        .powered-by a { color: var(--text-secondary); }

        /* Debug */
        .debug-panel {
            background: var(--bg-card); border-radius: var(--radius-lg);
            padding: var(--spacing-3) var(--spacing-4);
            border: 1px solid var(--border-light); width: 100%;
        }
        .debug-panel h4 {
            font-size: 0.6875rem; font-weight: 600; color: var(--text-tertiary);
            margin-bottom: var(--spacing-2); display: flex; align-items: center;
            justify-content: space-between;
        }
        .debug-log {
            font-size: 0.625rem;
            font-family: 'JetBrains Mono', 'Fira Code', ui-monospace, monospace;
            color: var(--text-secondary); max-height: 120px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 2px;
        }
        .debug-log .log-error { color: var(--palette-red-500); }
        .debug-log .log-success { color: var(--palette-green-500); }

        .debug-actions {
            display: flex; gap: var(--spacing-2);
        }
        .debug-actions button {
            font-size: 0.5625rem; padding: 2px 6px; border-radius: var(--radius-sm);
            color: #fff; font-weight: 500;
        }
        .debug-actions .btn-download { background: var(--primary-default); }
        .debug-actions .btn-download:hover { background: var(--primary-hover); }
        .debug-actions .btn-clear { background: var(--palette-red-500); }
        .debug-actions .btn-clear:hover { opacity: 0.85; }

        .hidden { display: none; }

        @media (max-width: 480px) {
            .top-bar { width: 100%; padding: 0 var(--spacing-4); }
            .voice-container { width: 100%; height: calc(100vh - 50px); border-radius: 0; }
        }
    </style>
    <script>
        window.loadSDK = async function() {
            const sources = [
                'https://cdn.skypack.dev/ultravox-client@0.4.1',
                'https://unpkg.com/ultravox-client@0.4.1?module',
                'https://esm.run/ultravox-client@0.4.1',
                'https://cdn.jsdelivr.net/npm/ultravox-client@0.4.1/+esm'
            ];
            for (const src of sources) {
                try {
                    const mod = await import(src);
                    if (mod.UltravoxSession) {
                        window.UltravoxSession = mod.UltravoxSession;
                        console.log('SDK loaded from:', src);
                        return true;
                    }
                } catch (e) { console.log('Failed:', src); }
            }
            return false;
        };
    </script>
</head>
<body>
    <div class="page-wrapper">
        <!-- Top bar: logo + theme toggle -->
        <div class="top-bar">
            <div class="logo-container">
                <img src="/static/talkaFlow_logo_light_mode.png" alt="TalkaFlow" class="logo-light">
                <img src="/static/talkaFlow_logo_dark_mode.png" alt="TalkaFlow" class="logo-dark">
            </div>
            <div class="theme-toggle" onclick="toggleTheme()">
                <div class="theme-track">
                    <div class="theme-icon theme-icon-sun" id="icon-sun">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                    </div>
                    <div class="theme-icon theme-icon-moon" id="icon-moon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                    </div>
                    <div class="theme-thumb" id="theme-thumb"></div>
                </div>
            </div>
        </div>

        <!-- Main frame -->
        <div class="voice-container">
            <!-- Indigo header bar -->
            <div class="voice-header">
                <div class="header-icon"><i id="agentIcon" class="fas fa-headset"></i></div>
                <div class="info">
                    <h2 id="agentName">Voice Assistant</h2>
                    <p><span class="status-dot-header"></span><span id="agentTitle">Ready</span></p>
                </div>
            </div>

            <!-- Content -->
            <div class="voice-content">
                <!-- Status -->
                <div class="status-area">
                    <div class="status-label" id="status-text">Ready</div>
                    <div class="status-sub" id="status-sub">Click below to start a voice call</div>
                </div>

                <!-- Call Button -->
                <div class="call-area">
                    <button id="call-btn" class="call-btn" disabled>
                        <i id="call-icon" class="fas fa-phone"></i>
                    </button>
                    <p class="call-label" id="call-label">Start Call</p>
                </div>

                <!-- Suggestions -->
                <div class="suggestions" id="suggestions">
                    <p class="label"><i class="fas fa-lightbulb"></i> Try saying:</p>
                    <div id="suggestionsList"></div>
                </div>

                <!-- Transcript -->
                <div class="transcript-section">
                    <div class="transcript-title">
                        <i class="fas fa-comments"></i> Conversation
                    </div>
                    <div class="transcript-area" id="transcript">
                        <div class="transcript-placeholder">
                            <i class="fas fa-microphone"></i>
                            Start a call to speak with the AI assistant
                        </div>
                    </div>
                </div>

                <!-- Debug -->
                <div class="debug-panel hidden" id="debug-panel">
                    <h4>
                        <span>Debug Log</span>
                        <div class="debug-actions">
                            <button class="btn-download" id="downloadLogsBtn" title="Download logs"><i class="fas fa-download"></i> Download</button>
                            <button class="btn-clear" id="clearLogsBtn" title="Clear logs"><i class="fas fa-trash"></i> Clear</button>
                        </div>
                    </h4>
                    <div class="debug-log" id="debug-log"></div>
                </div>
            </div>

            <!-- Footer -->
            <div class="nav-links">
                <a href="#" id="debug-toggle"><i class="fas fa-bug"></i> Debug</a>
            </div>

            <div class="powered-by">Powered by <a href="https://www.talkaflow.com">TalkaFlow</a></div>
        </div>
    </div>

    <script>
        // ========== Theme Toggle ==========
        function toggleTheme() {
            var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            var newTheme = isDark ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            document.documentElement.classList.toggle('dark', newTheme === 'dark');
            localStorage.setItem('theme', newTheme);
            syncToggleUI(newTheme === 'dark');
        }
        function syncToggleUI(isDark) {
            var thumb = document.getElementById('theme-thumb');
            var sun = document.getElementById('icon-sun');
            var moon = document.getElementById('icon-moon');
            if (thumb) thumb.style.transform = isDark ? 'translateX(24px)' : 'translateX(0)';
            if (sun) sun.style.opacity = isDark ? '0' : '1';
            if (moon) moon.style.opacity = isDark ? '1' : '0';
        }
        document.addEventListener('DOMContentLoaded', function() {
            syncToggleUI(document.documentElement.getAttribute('data-theme') === 'dark');
        });

        // ========== Agent Config ==========
        let agentConfig = null;
        let agentsData = null;

        function getAgentType() {
            const urlParams = new URLSearchParams(window.location.search);
            const queryAgent = urlParams.get('agent');
            if (queryAgent) return queryAgent;

            const path = window.location.pathname;
            const pathMatch = path.match(/\/(hotel|clinic|aftersales|restaurant|hairstudio|hepa|dental|littlehotelier)/);
            if (pathMatch) return pathMatch[1];

            return 'hotel';
        }

        const agentType = getAgentType();

        fetch('/agents-config.json')
            .then(res => res.json())
            .then(data => {
                agentsData = data;
                agentConfig = data[agentType];

                if (!agentConfig) {
                    console.error('Unknown agent type:', agentType);
                    agentConfig = data.hotel;
                }

                updateAgentInfo();
                updateCallButton();
            })
            .catch(err => {
                console.error('Failed to load agent config:', err);
            });

        function updateAgentInfo() {
            if (!agentConfig) return;

            document.title = `${agentConfig.name} - TalkaFlow Voice AI`;
            document.getElementById('pageTitle').textContent = `${agentConfig.name} - TalkaFlow`;
            document.getElementById('agentName').textContent = agentConfig.name;
            document.getElementById('agentTitle').textContent = agentConfig.title;
            document.getElementById('agentIcon').className = `fas ${agentConfig.icon}`;

            // Update suggestions
            const suggestionsList = document.getElementById('suggestionsList');
            suggestionsList.innerHTML = '';
            agentConfig.suggestions.forEach(suggestion => {
                const p = document.createElement('p');
                p.textContent = `"${suggestion}"`;
                suggestionsList.appendChild(p);
            });

            log(`Agent loaded: ${agentConfig.name} (${agentConfig.id})`);
        }

        // ========== UI Elements ==========
        const callBtn = document.getElementById('call-btn');
        const callIcon = document.getElementById('call-icon');
        const callLabel = document.getElementById('call-label');
        const statusText = document.getElementById('status-text');
        const statusSub = document.getElementById('status-sub');
        const transcriptEl = document.getElementById('transcript');
        const debugLog = document.getElementById('debug-log');
        const debugPanel = document.getElementById('debug-panel');
        const suggestionsEl = document.getElementById('suggestions');

        // ========== State ==========
        let session = null;
        let isConnected = false;
        let audioStream = null;
        let logHistory = [];
        let errorCount = 0;
        let currentSessionId = null;
        let callStartTime = null;
        let pendingServerLogs = [];
        let serverLogTimer = null;

        // ========== Call Logging with localStorage ==========
        function saveLogToStorage(logEntry) {
            try {
                const storedLogs = localStorage.getItem('talkaflow_call_logs');
                let logs = storedLogs ? JSON.parse(storedLogs) : [];
                logs.push(logEntry);
                if (logs.length > 500) logs = logs.slice(-500);
                localStorage.setItem('talkaflow_call_logs', JSON.stringify(logs));
            } catch (error) {
                console.error('Failed to save log to storage:', error);
            }
        }

        function getStoredLogs() {
            try {
                const storedLogs = localStorage.getItem('talkaflow_call_logs');
                return storedLogs ? JSON.parse(storedLogs) : [];
            } catch (error) {
                console.error('Failed to read logs from storage:', error);
                return [];
            }
        }

        function clearStoredLogs() {
            try {
                localStorage.removeItem('talkaflow_call_logs');
                console.log('All call logs cleared from storage');
            } catch (error) {
                console.error('Failed to clear logs:', error);
            }
        }

        function downloadLogs() {
            try {
                const logs = getStoredLogs();
                const logText = logs.map(entry => {
                    return `[${entry.fullTimestamp}] [Session: ${entry.sessionId || 'N/A'}] [${entry.type.toUpperCase()}] ${entry.message}`;
                }).join('\n');

                const blob = new Blob([logText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `talkaflow_logs_${new Date().toISOString().replace(/:/g, '-')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                log('Logs downloaded successfully', 'success');
            } catch (error) {
                log(`Failed to download logs: ${error.message}`, 'error');
            }
        }

        // ========== Server Log Submission ==========
        async function sendLogsToServer(logEntries, immediate = false) {
            if (!logEntries || logEntries.length === 0) return;
            try {
                for (const logEntry of logEntries) {
                    const response = await fetch('/api/submit-log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(logEntry)
                    });
                    if (!response.ok) console.warn('Failed to send log to server:', response.status);
                }
            } catch (error) {
                console.warn('Could not send logs to server:', error.message);
            }
        }

        function queueServerLog(logEntry, immediate = false) {
            pendingServerLogs.push(logEntry);
            if (immediate) {
                sendLogsToServer([...pendingServerLogs], true);
                pendingServerLogs = [];
                if (serverLogTimer) { clearTimeout(serverLogTimer); serverLogTimer = null; }
            } else {
                if (serverLogTimer) clearTimeout(serverLogTimer);
                serverLogTimer = setTimeout(() => {
                    if (pendingServerLogs.length > 0) {
                        sendLogsToServer([...pendingServerLogs]);
                        pendingServerLogs = [];
                    }
                    serverLogTimer = null;
                }, 5000);
            }
        }

        // ========== Logging ==========
        function log(message, type = 'info') {
            const now = new Date();
            const timestamp = now.toLocaleTimeString();
            const fullTimestamp = now.toISOString();

            const div = document.createElement('div');
            if (type === 'error') div.className = 'log-error';
            else if (type === 'success') div.className = 'log-success';
            div.textContent = `[${timestamp}] ${message}`;
            debugLog.appendChild(div);
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[${timestamp}] ${message}`);

            const logEntry = {
                timestamp, fullTimestamp, message, type,
                sessionId: currentSessionId,
                agentType: agentType,
                browser: navigator.userAgent,
                online: navigator.onLine
            };

            logHistory.push(logEntry);
            if (logHistory.length > 50) logHistory.shift();

            saveLogToStorage(logEntry);

            const isCritical = type === 'error' ||
                message.includes('CALL SESSION STARTED') ||
                message.includes('CALL DISCONNECTED') ||
                message.includes('CALL FAILED');
            queueServerLog(logEntry, isCritical);
        }

        // ========== Status ==========
        function setStatus(status, sub) {
            statusText.textContent = status;
            if (sub) statusSub.textContent = sub;
        }

        function updateCallButton() {
            if (isConnected) {
                callBtn.disabled = false;
                callBtn.classList.add('active');
                callIcon.className = 'fas fa-phone-slash';
                callLabel.textContent = 'End Call';
            } else {
                callBtn.classList.remove('active');
                callIcon.className = 'fas fa-phone';
                callLabel.textContent = 'Start Call';
                callBtn.disabled = typeof UltravoxSession === 'undefined' || !agentConfig;
            }
        }

        // ========== Transcript Rendering ==========
        function renderAllTranscripts(allTranscripts) {
            if (!allTranscripts || allTranscripts.length === 0) return;

            // Clear placeholder
            if (transcriptEl.querySelector('.transcript-placeholder')) {
                transcriptEl.innerHTML = '';
            }

            // Filter to transcripts with text
            const valid = allTranscripts.filter(t => t && t.text && t.text.trim());
            if (valid.length === 0) return;

            // Re-render all transcripts from scratch for reliability
            transcriptEl.innerHTML = '';
            let prevSpeaker = null;
            let currentDiv = null;
            const agentName = agentConfig ? agentConfig.name : 'AI';

            valid.forEach(t => {
                const isUser = t.speaker === 'user';
                const speaker = isUser ? 'user' : 'agent';

                if (speaker !== prevSpeaker) {
                    const div = document.createElement('div');
                    div.className = `transcript-msg ${isUser ? 'user-msg' : 'agent-msg'}`;
                    div.innerHTML = `
                        <div class="transcript-avatar ${isUser ? 'user-avatar' : 'agent-avatar'}">
                            <i class="fas ${isUser ? 'fa-user' : 'fa-headset'}"></i>
                        </div>
                        <div>
                            <div class="transcript-speaker ${isUser ? 'user-name' : 'agent-name'}">${isUser ? 'You' : agentName}</div>
                            <div class="transcript-text msg-text"></div>
                        </div>`;
                    transcriptEl.appendChild(div);
                    currentDiv = div;
                    prevSpeaker = speaker;
                }

                if (currentDiv) {
                    currentDiv.querySelector('.msg-text').textContent = t.text.trim();
                }
            });

            transcriptEl.scrollTop = transcriptEl.scrollHeight;
        }

        function addMessage(speaker, text) {
            // For system messages (e.g. end-of-call), append directly
            if (transcriptEl.querySelector('.transcript-placeholder')) {
                transcriptEl.innerHTML = '';
            }
            const isUser = speaker === 'user';
            const agentName = agentConfig ? agentConfig.name : 'AI';
            const div = document.createElement('div');
            div.className = `transcript-msg ${isUser ? 'user-msg' : 'agent-msg'}`;
            div.innerHTML = `
                <div class="transcript-avatar ${isUser ? 'user-avatar' : 'agent-avatar'}">
                    <i class="fas ${isUser ? 'fa-user' : 'fa-headset'}"></i>
                </div>
                <div>
                    <div class="transcript-speaker ${isUser ? 'user-name' : 'agent-name'}">${isUser ? 'You' : agentName}</div>
                    <div class="transcript-text msg-text">${text}</div>
                </div>`;
            transcriptEl.appendChild(div);
            transcriptEl.scrollTop = transcriptEl.scrollHeight;
        }

        // ========== API Call ==========
        async function createCall() {
            try {
                log(`Making API request via proxy: /api/ultravox`);
                const response = await fetch('/api/ultravox', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ agentId: agentConfig.id })
                });

                log(`Response status: ${response.status}`);

                if (!response.ok) {
                    const errorData = await response.json();
                    log(`API error response: ${JSON.stringify(errorData)}`, 'error');
                    throw new Error(`API Error ${response.status}: ${errorData.error || 'Unknown error'}`);
                }

                const data = await response.json();
                log(`Call created successfully: ${data.callId}`, 'success');
                return data;
            } catch (error) {
                log(`Fetch error: ${error.message}`, 'error');
                if (error.message.includes('Failed to fetch')) {
                    throw new Error('Network error: Unable to connect to API proxy.');
                }
                throw error;
            }
        }

        // ========== Start Call ==========
        async function startCall() {
            try {
                currentSessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                callStartTime = new Date();

                log('=== NEW CALL SESSION STARTED ===', 'info');
                log(`Session ID: ${currentSessionId}`, 'info');
                log(`Agent: ${agentConfig.name} (${agentConfig.id})`, 'info');
                log('Starting voice call...');
                setStatus('Connecting...', 'Setting up voice connection');
                callBtn.disabled = true;

                if (typeof UltravoxSession === 'undefined') {
                    throw new Error('Voice SDK not loaded. Please refresh the page.');
                }

                if (!agentConfig) {
                    throw new Error('Agent configuration not loaded. Please refresh the page.');
                }

                // Request microphone
                log('Requesting microphone permission...');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    log('Microphone permission granted', 'success');

                    const audioContext = new AudioContext();
                    const source = audioContext.createMediaStreamSource(stream);
                    const analyser = audioContext.createAnalyser();
                    source.connect(analyser);
                    await new Promise(resolve => setTimeout(resolve, 200));

                    const dataArray = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;

                    if (average > 0) {
                        log(`Microphone is active (level: ${Math.floor(average)})`, 'success');
                    } else {
                        log('Microphone ready (background noise level: low)', 'info');
                    }

                    audioStream = stream;
                } catch (micError) {
                    log(`Microphone permission denied: ${micError.message}`, 'error');
                    throw new Error('Microphone access required for voice calls. Please allow microphone access and try again.');
                }

                // Create call
                const callData = await createCall();
                log(`Call created: ${callData.callId}`, 'success');

                // Initialize session
                session = new UltravoxSession();

                session.addEventListener('status', () => {
                    const s = session.status;
                    log(`Status: ${s}`);
                    if (s === 'listening') setStatus('Listening', 'Speak now...');
                    else if (s === 'speaking') setStatus('AI Speaking', agentConfig ? `${agentConfig.name} is responding` : 'AI is responding');
                    else if (s === 'idle' || s === 'connected') setStatus('Connected', 'Call active');
                    else if (s === 'disconnected') endCallUI();

                    isConnected = s !== 'disconnected';
                    updateCallButton();
                });

                session.addEventListener('transcripts', () => {
                    const transcripts = session.transcripts;
                    if (transcripts && transcripts.length > 0) {
                        const latest = transcripts[transcripts.length - 1];
                        if (latest.isFinal) {
                            log(`Transcript: [${latest.speaker}] "${latest.text}" (final: ${latest.isFinal})`);
                        }
                        renderAllTranscripts(transcripts);
                    }
                });

                session.addEventListener('error', (event) => {
                    log(`Session error: ${JSON.stringify(event)}`, 'error');
                });

                session.addEventListener('disconnect', (event) => {
                    const disconnectTime = new Date();
                    log('=== CALL DISCONNECTED ===', 'error');
                    log(`Disconnect time: ${disconnectTime.toISOString()}`, 'error');
                    log(`Session ID: ${currentSessionId}`, 'error');

                    if (callStartTime) {
                        const callDuration = Math.floor((disconnectTime - callStartTime) / 1000);
                        log(`Total call duration: ${callDuration} seconds`, 'error');
                    }

                    if (event && event.detail) {
                        log(`Disconnect reason: ${JSON.stringify(event.detail)}`, 'error');
                    }

                    log(`Network online: ${navigator.onLine}`, 'error');
                    log(`Connection type: ${navigator.connection?.effectiveType || 'Unknown'}`, 'error');

                    if (isConnected) {
                        const wasShort = callStartTime && (Date.now() - callStartTime < 10000);
                        if (wasShort) {
                            addMessage('agent', 'Call ended shortly after greeting. This may be due to: (1) No microphone input detected, (2) Agent timeout, or (3) Network issue. Please ensure your microphone is working and try again.');
                            log('Short call detected - likely microphone or agent timeout issue', 'error');
                        } else {
                            addMessage('agent', 'Call disconnected unexpectedly. Please check your internet connection and microphone permissions.');
                        }
                    }

                    endCallUI();
                });

                // Monitor connection quality
                let lastActivityTime = Date.now();
                const activityMonitor = setInterval(() => {
                    if (session && isConnected) {
                        const timeSinceActivity = Date.now() - lastActivityTime;
                        if (timeSinceActivity > 30000) {
                            log(`No activity for ${Math.floor(timeSinceActivity / 1000)}s`, 'error');
                        }
                    } else {
                        clearInterval(activityMonitor);
                    }
                }, 10000);

                session.addEventListener('transcripts', () => {
                    lastActivityTime = Date.now();
                });

                // Join call
                log('Joining call...');
                await session.joinCall(callData.joinUrl);
                log('Voice call connected!', 'success');
                lastActivityTime = Date.now();

                isConnected = true;
                callBtn.disabled = false;
                callBtn.classList.add('active');
                callIcon.className = 'fas fa-phone-slash';
                callLabel.textContent = 'End Call';
                suggestionsEl.classList.add('hidden');
                setStatus('Connected', 'Call active - speak now');

            } catch (error) {
                log('=== CALL FAILED TO START ===', 'error');
                log(`Error: ${error.message}`, 'error');
                log(`Error stack: ${error.stack}`, 'error');
                log(`Session ID: ${currentSessionId}`, 'error');
                setStatus('Error', error.message);
                endCallUI();
                currentSessionId = null;
                callStartTime = null;
                alert(`Failed to start call: ${error.message}`);
            }
        }

        // ========== End Call ==========
        async function endCall() {
            try {
                log('=== USER ENDED CALL ===', 'info');
                log('Ending call...');

                if (callStartTime) {
                    const endTime = new Date();
                    const callDuration = Math.floor((endTime - callStartTime) / 1000);
                    log(`Call duration: ${callDuration} seconds`, 'info');
                }

                if (session) {
                    await session.leaveCall();
                    session = null;
                }

                if (audioStream) {
                    audioStream.getTracks().forEach(track => track.stop());
                    audioStream = null;
                }

                log('Call ended successfully', 'success');
                log(`Session ID: ${currentSessionId}`, 'info');

                addMessage('agent', `Thank you for contacting ${agentConfig ? agentConfig.name : 'us'}. Have a wonderful day!`);

                currentSessionId = null;
                callStartTime = null;

            } catch (error) {
                log(`Error ending call: ${error.message}`, 'error');
            }
            endCallUI();
        }

        function endCallUI() {
            isConnected = false;
            callBtn.disabled = false;
            callBtn.classList.remove('active');
            callIcon.className = 'fas fa-phone';
            callLabel.textContent = 'Start Call';
            suggestionsEl.classList.remove('hidden');
            setStatus('Call Ended', 'Click to start a new call');
            updateCallButton();
        }

        // ========== Event Listeners ==========
        callBtn.addEventListener('click', () => {
            if (isConnected) endCall(); else startCall();
        });

        document.getElementById('debug-toggle').addEventListener('click', (e) => {
            e.preventDefault();
            debugPanel.classList.toggle('hidden');
        });

        document.getElementById('downloadLogsBtn').addEventListener('click', () => {
            downloadLogs();
        });

        document.getElementById('clearLogsBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all saved call logs? This cannot be undone.')) {
                clearStoredLogs();
                log('All logs cleared from storage', 'success');
            }
        });

        // ========== Network Monitoring ==========
        window.addEventListener('online', () => {
            log('Network connection restored', 'success');
        });

        window.addEventListener('offline', () => {
            log('Network connection lost!', 'error');
            if (session && isConnected) {
                alert('Network connection lost. The call may disconnect.');
            }
        });

        window.addEventListener('beforeunload', () => {
            if (pendingServerLogs.length > 0) {
                sendLogsToServer([...pendingServerLogs], true);
            }
            if (session && isConnected) {
                log('Page closing - ending call automatically');
                try { session.leaveCall(); } catch (e) {}
                if (audioStream) audioStream.getTracks().forEach(track => track.stop());
            }
        });

        window.addEventListener('pagehide', () => {
            if (session && isConnected) {
                log('Page unloading - ending call');
                try { session.leaveCall(); } catch (e) {}
            }
        });

        // ========== Initialize ==========
        document.addEventListener('DOMContentLoaded', async () => {
            log('TalkaFlow Voice AI Interface loaded');
            log(`Browser: ${navigator.userAgent}`);
            log(`Online: ${navigator.onLine ? 'Yes' : 'No'}`);
            log(`Connection: ${navigator.connection?.effectiveType || 'Unknown'}`);
            log(`Agent Type: ${agentType}`);

            const storedLogs = getStoredLogs();
            log(`Stored logs: ${storedLogs.length} entries in localStorage`);
            if (storedLogs.length > 0) {
                log(`Oldest log: ${storedLogs[0].fullTimestamp}`);
                log(`Newest log: ${storedLogs[storedLogs.length - 1].fullTimestamp}`);
            }

            log('Loading voice processing SDK...');
            try {
                const loaded = await window.loadSDK();
                if (loaded) {
                    log('Voice SDK loaded successfully!', 'success');
                    updateCallButton();
                } else {
                    log('Failed to load voice SDK', 'error');
                    setStatus('Error', 'Voice SDK could not load');
                }
            } catch (error) {
                log(`SDK error: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>
